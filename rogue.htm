<!-- work in progress, excuse the hacky code/markup -->
<body onkeypress="GetChar(event)"></body>
<script>
var h = '#';
var n = 30*80;
var a = new Array(n);
var x = 0;
var y = 0;

var found = 0;

var toggle = 1;

//found |= (j)%80==40+entities[i] && ~~(j/80)==14+entities[i+1];

var entities = [1,14,2,4,6,8];
console.log(entities);

function pass(v) {
    return ".".indexOf(a[v]) !== -1
}
//Math.abs(c^7 - 4*c^5 + 13*c^3 + c^2 - 5*c + 11) % 5 == 1
function gen(l) {
    //console.log((x)^2+(y)^2)  (l)%80==10 && 
    return Math.abs(l^7 - 4*l^5 + 13*l^3 + l^2 - 5*l + 11) % 5 == 1;
}

function ca(c) {
    return g9(c) > 3 ? 1 : 0;
}

function g9(c) {
    return gen(c-81)+gen(c-80)+gen(c-79)+
    gen(c-1)+gen(c)+gen(c+1)+
    gen(c+79)+gen(c+80)+gen(c+81);
}

function ag9(c,a) {
    return a[c-81]+a[c-80]+a[c-79]+
    a[c-1]+a[c]+a[c+1]+
    a[c+79]+a[c+80]+a[c+81];
}

function run() {
    var b = [];
    var d = [];
    var f = [];
    
    for(var j=0;j<n;j++) {
        //d[j] = ca(b[j]) ? '#' : '.';
        //a[j] = d[j];
        var k = gen(Math.abs(j+x+y*80));//gen(j,x,y);//gen(b[j+81]);
        found =0;
        //are any entities on the grid?
         for(var i=0;i<6;i+=2){
            //Math.abs(x-entities[i]) > Math.abs(y-entities[i+1]) ? (entities[i] > x ? entities[i]-=1 : entities[i]+=1) : (entities[i+1] > y ? entities[i+1]-=1 : entities[i+1]+=1);
            found |= (j+x)%80==entities[i] && ~~(j/80)+y==entities[i+1];
         }
         
        var terrain = k ? '#' : '.';
        a[j] = found ? 'E' : terrain;
        a[j] += j % 80==79 ? '\n' : '';
    }
        for(var i=0;i<6;i+=2){
        //k ? k=i : k=i+1;
            //entities[i] = (x + entities[i])
        //move to player
        Math.abs(x+40-entities[i]) > Math.abs(y+14-entities[i+1]) ? (entities[i] > x+40 ? entities[i]-=1 : entities[i]+=1) : (entities[i+1] > y+14 ? entities[i+1]-=1 : entities[i+1]+=1);
        //var foo = entities[i] < -40 && entities[i] < 80 && entities[i+1] < -30 && entities[i+1] < 30;
        //a[entities[i]+(entities[i+1])*80] = 'G'//foo ? 'G' : a[40+entities[i]+(14+entities[i+1])*80];
        }
    //console.log(toggle);
    toggle += 1;
    a[40+14*80]='@';
    //document.getElementById('r').value = a.join("\n");
    document.body.innerHTML = "<pre>"+a.join("");
}
run();
console.log(entities);
function GetChar (event){
    var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
    if (119 == chCode && pass(40+14*80-80)){
        y--;
    }
    if (115 == chCode && pass(40+14*80+80)){
        y++;
    }
    if (97 == chCode && pass(40+14*80-1)){
        x--;
    }
    if (100 == chCode && pass(40+14*80+1)){
        x++;
    }
    run();
    console.log (x+","+y);
    console.log(entities);
}

</script>

<!-- work in progress, excuse the hacky code/markup -->
<body onkeypress="GetChar(event)"></body>
<script>
var h = '#';
var n = 30*80;
var a = new Array(n);
var x = 0;
var y = 0;

var HP = 30;
var maxHP = 30;

var found = 0;

//found |= (j)%80==40+entities[i] && ~~(j/80)==14+entities[i+1];

var entities = [10,5,
                20,10,
                60,20];

function gen(l) {
    //console.log((x)^2+(y)^2)  (l)%80==10 && 
    return Math.abs(l^7 - 4*l^5 + 13*l^3 + l^2 - 5*l + 11) % 5 == 1;
}

function gen2(l) {
    return Math.abs(l^7 - 4*l^5 + 13*l^3 + l^2 - 5*l + 11) % 5;
}

function gen1(l) {
    return Math.abs(l^7 - 4*l^5 + 13*l^3 + l^2 - 5*l + 11) % 5;
}

function pass(px,py,c) {
    return !gen(Math.abs(px+py*80));
}

function ca(c) {
    return g9(c) > 3 ? 1 : 0;
}

function g9(c) {
    return gen(c-81)+gen(c-80)+gen(c-79)+
    gen(c-1)+gen(c)+gen(c+1)+
    gen(c+79)+gen(c+80)+gen(c+81);
}

function ag9(c,a) {
    return a[c-81]+a[c-80]+a[c-79]+
    a[c-1]+a[c]+a[c+1]+
    a[c+79]+a[c+80]+a[c+81];
}

function run() {
    var b = [];
    var d = [];
    var f = [];
    
    for(var j=0;j<n;j++) {
        //d[j] = ca(b[j]) ? '#' : '.';
        //a[j] = d[j];
        var k = gen(Math.abs(j+x+y*80));//gen(j,x,y);//gen(b[j+81]);
        //var k = gen(Math.abs((j%80)+x+~~(j/80)+y*80));
        found =0;
        //are any entities on the grid?
         for(var i=0;i<6;i+=2){
            found |= (j%80)+x==entities[i] && ~~(j/80)+y==entities[i+1];
         }
        var terrain = k ? '#' : '.';
        a[j] = found ? 'E' : terrain;
        a[j] += j % 80==79 ? '\n' : '';
    }
    for(var i=0;i<6;i+=2){
        
        //k ? k=i : k=i+1;
            //entities[i] = (x + entities[i])
        var e1 = entities[i];
        var e2 = entities[i+1];
        
        var ediffx = e1-(x+40);
        var ediffy = e2-(y+14);
        
        //var sign = number && number / Math.abs(number);
        
        console.log(ediffx, ediffy);
        
        if (Math.abs(ediffx) >= Math.abs(ediffy)) {
            if(ediffx < 0) { // || pass(entities[i]+1,entities[i+1])) {
                entities[i] += 1;
            }
            else if(ediffx > 0) { // || pass(entities[i]-1,entities[i+1])) {
                entities[i] -= 1;
            }
       }
       else if (Math.abs(ediffx)< Math.abs(ediffy)) {     
            if(ediffy < 0) { // || pass(entities[i],entities[i+1]+1)) {
                entities[i+1] += 1;
            }
            else if(ediffy > 0) { // || pass(entities[i],entities[i+1]-1)) {
                entities[i+1] -= 1;
            }
        }
    }
    a[40+14*80]='@';
    a[2400] = HP+'/'+maxHP;
    document.body.innerHTML = "<pre>"+a.join("");
}
run();
function GetChar (event){
    var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
    pass(x+40,y+14,'c');
    if (119 == chCode){ //&& pass(x+40,y+13)){
        y--;
    }
    if (115 == chCode){ //&& pass(x+40,y+15)){
        y++;
    }
    if (97 == chCode){ //&& pass(x+39,y+14)){
        x--;
    }
    if (100 == chCode){ //&& pass(x+41,y+14)){
        x++;
    }
    run();
    console.log ('@:',x,y);
    console.log(entities);
}

</script>

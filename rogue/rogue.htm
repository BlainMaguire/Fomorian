<!-- work in progress, excuse the hacky code/markup -->
<body onkeypress="GetChar(event)"></body>
<script>
var h = '#';
var n = 30*80;
var a = new Array(n);
var x = 0;
var y = 0;
var z = 0;
var g = [];
var gt = [];
var ct = [];

var HP = 30;
var maxHP = 30;

var found = 0;

var entities = [];//10,5,
//                20,10,
//                60,20];

var caves = [];
var seed = 1;
function noise() {
    return seed = Math.abs(seed * 16807|0);
}

function genCave(x,y) {
    var cx = 0, cy = 0, d = [], delta =0, ff=0;
    ff= seed = 1+Math.abs(x+y);
    for (var c = 0; c < 300+ff; c+=3) {
        var rad = 2+noise()%8;
        d[c] = 40 + x + cx;
        d[c+1] = 14 + y +cy;
        d[c+2] = rad;
        delta = noise()%5 > 2 ? rad : rad*-1
        delta /= 2;
        noise()%5 > 2 ? cy+=delta : cx+=delta;
    }
    caves = d;
}

genCave(0,0);

function magic(x) {
    
    return (x - ~~(x/80)*80) > 5*80 && (x - (~~(x/80))) < 6*80;
}

function gen(l) {
    return g[l] ? g[l] : g[l] = magic(l);
}

function pass(x,y,c) {
    return !ca(x,y);
}

function elipse(x, y,x2, y2, r) {
    return (x-x2)*(x-x2) + (y-y2)*(y-y2) < r*r;
}

function ca(x, y) {
    var found = 0;
    for(var i=0;i<caves.length;i+=3){
        found |= elipse(x,y,caves[i],caves[i+1],caves[i+2]);
    }
    
    return found<1;
}


function run() {
    var b = [];
    var d = [];
    var f = [];
    
    for(var j=0;j<n;j++) {
        var k = ca((j % 80)+ x, ~~(j/80)+y);
        found =0;
        //are any entities on the grid?
         for(var i=0;i<6;i+=2){
            found |= (j%80)+x==entities[i] && ~~(j/80)+y==entities[i+1];
         }
        var terrain = k ? '#' : '.';
        a[j] = found ? 'E' : terrain;
        a[j] += j % 80==79 ? '\n' : '';
    }
    for(var i=0;i<6;i+=2){
        
        var e1 = entities[i];
        var e2 = entities[i+1];
        
        var ediffx = e1-(x+40);
        var ediffy = e2-(y+14);
        
        //var sign = number && number / Math.abs(number);
        
        //console.log(ediffx, ediffy);
        
        if (Math.abs(ediffx) >= Math.abs(ediffy)) {
            if(ediffx < 0 && pass(entities[i]+1,entities[i+1])) {
                entities[i] += 1;
            }
            else if(ediffx > 0 && pass(entities[i]-1,entities[i+1])) {
                entities[i] -= 1;
            }
       }
       if (e1 == entities[i]) {     
            if(ediffy < 0 && pass(entities[i],entities[i+1]+1)) {
                entities[i+1] += 1;
            }
            else if(ediffy > 0 && pass(entities[i],entities[i+1]-1)) {
                entities[i+1] -= 1;
            }
        }
    }
    a[40+14*80]='@';
    a[2400] = HP+'/'+maxHP + ' x: '+x+' y: '+y+' z: '+z;
    document.body.innerHTML = "<pre>"+a.join("");
}
run();
function GetChar (event){
    var chCode = ('charCode' in event) ? event.charCode : event.keyCode;
    if (119 == chCode && pass(x+40, y+13)){
        y--;
    }
    if (115 == chCode && pass(x+40, y+15)){
        y++;
    }
    if (97 == chCode && pass(x+39, y+14)){
        x--;
    }
    if (100 == chCode && pass(x+41, y+14)){
        x++;
    }
    run();
    //console.log(g.length);
}

</script>
